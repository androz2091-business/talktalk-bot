<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Details - <%= student.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="dashboard-title">Student Details</h1>
                    <p class="dashboard-subtitle"><%= student.name %></p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="/" class="btn btn-secondary me-2">‚Üê Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display:none;">
            <div class="loading-spinner"></div>
            <div class="mt-3 text-center fw-bold" style="font-size:1.2rem; color: #1D1C3B;">Loading...</div>
        </div>

        <!-- Calculate completion rate -->
        <% 
        const total = (student.count || 0) + (student.remaining || 0);
        const completionRate = total > 0 ? Math.round(((student.count || 0) / total) * 100) : 0;
        %>

        <!-- Student Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <span>üìä</span>
                </div>
                <div class="stat-value"><%= completionRate %>%</div>
                <div class="stat-label">Completion Rate</div>
            </div>

             <div class="stat-card">
                <div class="stat-icon warning">
                    <span>‚è≥</span>
                </div>
                <div class="stat-value"><%= student.remaining || 0 %></div>
                <div class="stat-label">Remaining</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <span>üìÖ</span>
                </div>
                <div class="stat-value">
                    <% if (student.expiration === 'INVALID') { %>
                        <small>Expired</small>
                    <% } else if (student.expiration && student.expiration !== 'TBD') { %>
                        <small style="font-size: 0.9rem;"><%= student.expiration %></small>
                    <% } else { %>
                        <small>TBD</small>
                    <% } %>
                </div>
                <div class="stat-label">Expiration Date</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Student Information -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Student Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h6 class="mt-3 mb-1"><%= student.name || 'Unknown Student' %></h6>
                            <p class="text-muted small"><%= student.email %></p>
                        </div>
                        
                        <div class="info-item mb-3">
                            <div class="text-muted small">Package</div>
                            <div class="fw-semibold"><%= student.currentPack || 0 %> Classes Total</div>
                        </div>
                        
                        <div class="info-item mb-3">
                            <div class="text-muted small">Progress</div>
                            <div class="progress mb-2" style="height: 10px; border-radius: 5px;">
                                <div class="progress-bar" style="width: <%= completionRate %>%; background: linear-gradient(90deg, #EB257A, #FEF538);"></div>
                            </div>
                            <div class="small"><%= student.count || 0 %> of <%= student.currentPack || 0 %> classes completed</div>
                        </div>
                        
                        <div class="info-item mb-3">
                            <div class="text-muted small">Expiration Date</div>
                            <div class="fw-semibold">
                                <% if (student.expiration && student.expiration !== 'TBD') { %>
                                    <%= student.expiration %>
                                <% } else { %>
                                    <span class="text-warning">To Be Determined</span>
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="text-muted small">Status</div>
                            <div>
                                <% 
                                const remaining = student.remaining || 0;
                                let statusClass = 'badge-success';
                                let statusText = 'Active';
                                if (remaining === 0) {
                                    statusClass = 'badge-danger';
                                    statusText = 'Expired';
                                } else if (remaining <= 3) {
                                    statusClass = 'badge-warning';
                                    statusText = 'Low Credits';
                                }
                                %>
                                <span class="badge <%= statusClass %>"><%= statusText %></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Class Progress Analytics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="chart-container mb-4 mb-md-0">
                                    <h6 class="text-center mb-3">Progress Overview</h6>
                                    <canvas id="progressChart" style="max-height: 250px;"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h6 class="text-center mb-3">Monthly Activity</h6>
                                    <canvas id="monthlyChart" style="max-height: 250px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Classes -->
        <% if (student.completedClasses && student.completedClasses.length > 0) { %>
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Class History</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="padding: 16px 20px;">Date & Time</th>
                                    <th style="padding: 16px 20px;">Title</th>
                                    <th style="padding: 16px 20px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% student.completedClasses.forEach(cls => { %>
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">
                                                <%= new Date(cls.date).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' }) %>, 
                                                <%= new Date(cls.date).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) %>
                                            </div>
                                        </td>
                                        <td>
                                            <% if (cls.title) { %>
                                                <div class="text-muted mt-2"><%= cls.title %></div>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (cls.cancelled) { %>
                                                <span class="badge badge-danger">Cancelled</span>
                                            <% } else { %>
                                                <span class="badge badge-success">Completed</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Progress Pie Chart
        const progressCtx = document.getElementById('progressChart').getContext('2d');
        new Chart(progressCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Remaining'],
                datasets: [{
                    data: [<%= student.count || 0 %>, <%= student.remaining || 0 %>],
                    backgroundColor: [
                        '#EB257A',
                        '#FEF538'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });

        // Monthly Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        const monthlyStats = <%- JSON.stringify(student.monthlyStats || []) %>;
        
        const monthlyData = monthlyStats.length > 0 ? monthlyStats.map(stat => ({
            month: stat.month,
            count: stat.count
        })) : [];

        new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: monthlyData.map(d => d.month),
                datasets: [{
                    label: 'Classes per Month',
                    data: monthlyData.map(d => d.count),
                    borderColor: 'rgba(235, 37, 122, 1)',
                    backgroundColor: 'rgba(235, 37, 122, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(235, 37, 122, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>